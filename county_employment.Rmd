---
title: "MSA Job Creation"
author: "John Mwangi"
date: "10/26/2021"
output: html_document
---

# Objective

Time series model for determining number of job opportinities in Mombasa County

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(forecast)
```

# Data importation

## KE Business Registrations

```{r}
ke_business_reg <-
read_excel(path = "../Data requirements/KE_business_registrations.xlsx") %>% 
  janitor::clean_names() %>% 
  select(year, adjusted) %>% 
  filter(!is.na(adjusted)) %>% 
  mutate(adjusted = round(adjusted)) %>% 
  rename(business_reg = adjusted) %>% 
  mutate(year = as.numeric(year))

ke_business_reg
```

## KE Inflation Rates

```{r}
ke_inflation_rates <-
read_excel(path = "../Data requirements/KE_inflation_rates.xls",
           sheet = "2021") %>% 
  select(Year, Value) %>% 
  janitor::clean_names() %>% 
  rename(inflation_rate = value) %>% 
  mutate(year = as.numeric(year))

ke_inflation_rates
```

## KE Unemployment Rates

```{r}
ke_unemployment_rate <-
read_excel(path = "../Data requirements/KE_unemployment_rates.xls", 
           skip = 3) %>%
  janitor::clean_names() %>% 
  filter(country_name=="Kenya") %>% 
  select(country_name, starts_with("x")) %>% 
  pivot_longer(cols = starts_with("x"),
               names_to = "year",
               values_to = "unemployment_rate") %>% 
  mutate(year = str_remove(string = year, pattern = "x")) %>% 
  filter(!is.na(unemployment_rate)) %>% 
  select(-country_name) %>% 
  mutate(unemployment_rate = unemployment_rate/100) %>% 
  mutate(year = as.numeric(year))

ke_unemployment_rate
```

## KE GDP Annual Growth

```{r}
ke_gdp <-
read_excel(path = "../Data requirements/KE_gdp.xls",
           sheet = "2021") %>% 
  janitor::clean_names() %>% 
  rename(gdp_growth = value) %>% 
  mutate(gdp_growth = gdp_growth/100) %>% 
  mutate(year = as.numeric(year))

ke_gdp
```

# Business Registrations Forecast

**Assumption:** Business registrations is a factor of National GDP.

National GDP was chosen since it is the only one that has forecasted values.

## ARIMAX model

```{r}
gdp_reg <-
ke_business_reg %>%
  full_join(ke_gdp, by = "year") %>%
  arrange(year) %>% 
  filter(!is.na(gdp_growth), !is.na(business_reg))

gdp_reg
```

```{r}
reg_model <- auto.arima(y = gdp_reg$business_reg, xreg = gdp_reg$gdp_growth)

reg_model
```

## Forecasted values

Forecast business registrations from 2022 to 2030. It is estimated that GDP will grow at 4.4% between 2020-2030.

```{r}
forecast(object = reg_model, 
         h = 9, 
         xreg = rep(0.044, times = 9)) %>% 
  plot()


reg_forecast <-
forecast(object = reg_model, 
         h = 9, 
         xreg = rep(0.044, times = 9)) %>% 
  as_tibble() %>% 
  janitor::clean_names() %>% 
  rename(business_reg = point_forecast) %>% 
  mutate(year = 2022:2030) %>% 
  bind_rows(ke_business_reg) %>% 
  arrange(year) %>% 
  relocate(year, .before = everything()) %>% 
  mutate(business_reg = round(business_reg))

reg_forecast
```

## CAGR

```{r}
CAGR_formula <- function(FV, PV, yrs) {
cagr <- ((FV/PV)^(1/yrs)-1)
return(cagr)
}

reg_cagr <- CAGR_formula(FV = 66120, PV = 46387, yrs = 2030-2022)
reg_cagr <- scales::percent(reg_cagr, accuracy = 0.01)
reg_cagr
```

## Plotted results

```{r}
reg_forecast %>% 
  ggplot(aes(x = year, y = business_reg)) +
  geom_line() +
  geom_ribbon(aes(ymin = lo_95, ymax = hi_95, alpha = 0.3), 
              fill = "grey70", 
              show.legend = FALSE) +
  scale_y_continuous(labels = scales::comma_format()) +
  scale_x_continuous(breaks = seq(2000, 2030, 5), minor_breaks = NULL) +
  expand_limits(y = 0, x = 2000) +
  labs(title = "Growth of Business Registrations in Kenya [2002-2030]",
       subtitle = glue::glue("Projected to grow at a CAGR of {reg_cagr} from 2022-2030"),
       x = NULL,
       y = "Number of Business Registrations")
```

# Unemployment Rate Forecast

## ARIMAX model

```{r}
reg_forecast
ke_gdp
ke_inflation_rates
ke_unemployment_rate

unemp_data <-
full_join(x = ke_gdp, y = reg_forecast, by = "year") %>% 
  full_join(ke_inflation_rates, by = "year") %>% 
  full_join(ke_unemployment_rate, by = "year") %>% 
  arrange(year) %>% 
  select(-starts_with(c("lo", "hi"))) %>% 
  relocate(unemployment_rate, .after = year) %>% 
  filter(complete.cases(.))

unemp_data
```


```{r}
unemp_data %>% 
  select(-year, -unemployment_rate) %>% 
  as.matrix()
```


```{r}
unemp_model <-
auto.arima(y = unemp_data$unemployment_rate, 
           xreg = unemp_data %>%
             select(-year, -unemployment_rate) %>%
             as.matrix())

unemp_model
```

## Forecasted values

Forecast unemployment rates from 2021-2030

```{r}
unemp_newdata <-
full_join(x = ke_gdp, y = reg_forecast, by = "year") %>% 
  full_join(ke_inflation_rates, by = "year") %>% 
  full_join(ke_unemployment_rate, by = "year") %>% 
  arrange(year) %>% 
  select(-starts_with(c("lo", "hi"))) %>% 
  relocate(unemployment_rate, .after = year) %>% 
  filter(year>=2021) %>% 
  select(-year, -unemployment_rate) %>% 
  as.matrix()

unemp_newdata
```

```{r}
forecast(object = unemp_model, h = 10, xreg = unemp_newdata) %>% plot()

unemp_forecast <-
forecast(object = unemp_model, h = 10, xreg = unemp_newdata) %>% 
  as_tibble() %>% 
  janitor::clean_names() %>% 
  mutate(year = 2021:2030) %>% 
  relocate(year, .before = everything()) %>% 
  rename(unemployment_rate = point_forecast)

unemp_forecast
```


```{r}
unemp_complete <-
full_join(x = ke_gdp, y = reg_forecast, by = "year") %>% 
  full_join(ke_inflation_rates, by = "year") %>% 
  full_join(ke_unemployment_rate, by = "year") %>% 
  arrange(year) %>% 
  select(-starts_with(c("lo", "hi"))) %>% 
  relocate(unemployment_rate, .after = year) %>% 
  left_join(unemp_forecast, by = "year") %>% 
  mutate(unemployment_rate = coalesce(unemployment_rate.x, unemployment_rate.y)) %>% 
  select(-unemployment_rate.x, -unemployment_rate.y) %>% 
  select(-contains("80")) %>% 
  arrange(year) %>% 
  filter(year>=2002)

unemp_complete
```

## Growth rate

```{r}
unemp_rates <-
unemp_complete %>% 
  filter(year>=2021) %>% 
  pull(unemployment_rate)

unemp_rates %>% 
  mean() %>% 
  scales::percent(accuracy = 0.01)

scales::percent(unemp_rates[length(unemp_rates)] - unemp_rates[1], accuracy = 0.01)
```

## Plotted results

```{r}
unemp_complete %>% 
  ggplot(aes(x = year, y = unemployment_rate)) +
  geom_line() +
  geom_ribbon(aes(ymin = lo_95, ymax = hi_95, alpha = 0.3), 
              fill = "grey70", 
              show.legend = FALSE) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_continuous(breaks = seq(2000, 2030, 5), minor_breaks = NULL) +
  geom_text(aes(label = scales::percent(unemployment_rate, accuracy = 0.01)), 
            check_overlap = TRUE) +
  expand_limits(x = 2000) +
  labs(title = "Unemployment Rates in Kenya [2002-2030]",
       subtitle = "Unemployment is expected to reduce 2.68% in 2030",
       x = NULL,
       y = "Unemployment Rate")
```


# Save results

```{r}
save.image(file = "26_Oct.RData")
```

```{r}
load(file = "26_Oct.RData")
```





