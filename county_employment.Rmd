---
title: "MSA Job Creation"
author: "John Mwangi"
date: "10/26/2021"
output: html_document
---

# Objective

Time series model for determining number of job opportunities in Mombasa County

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages

```{r message=FALSE, warning=FALSE}
rm(list = ls())

#load(file = "26_Oct.RData")

library(tidyverse)
library(readxl)
library(forecast)
library(writexl)
```

# Data importation

## KE Business Registrations

```{r}
ke_business_reg <-
read_excel(path = "../Data requirements/KE_business_registrations.xlsx") %>% 
  janitor::clean_names() %>% 
  select(year, adjusted) %>% 
  filter(!is.na(adjusted)) %>% 
  mutate(adjusted = round(adjusted)) %>% 
  rename(business_reg = adjusted) %>% 
  mutate(year = as.numeric(year))

ke_business_reg
```

## KE Inflation Rates

```{r}
ke_inflation_rates <-
read_excel(path = "../Data requirements/KE_inflation_rates.xls",
           sheet = "2021") %>% 
  select(Year, Value) %>% 
  janitor::clean_names() %>% 
  rename(inflation_rate = value) %>% 
  mutate(year = as.numeric(year))

ke_inflation_rates
```

## KE Employment Ratios

```{r}
ke_employment_ratios <-
read_excel(path = "../Data requirements/KE_employment_ratios.xls", 
           skip = 3) %>% 
  janitor::clean_names() %>% 
  filter(country_name=="Kenya") %>% 
  select(country_name, starts_with("x")) %>% 
  pivot_longer(cols = starts_with("x"),
               names_to = "year",
               values_to = "employment_ratio") %>% 
  mutate(year = str_remove(string = year, pattern = "x"),
         year = as.numeric(year),
         employment_ratio = employment_ratio/100) %>% 
  select(-country_name)

ke_employment_ratios
```

## KE GDP Annual Growth

```{r}
ke_gdp <-
read_excel(path = "../Data requirements/KE_gdp.xls",
           sheet = "2021") %>% 
  janitor::clean_names() %>% 
  rename(gdp_growth = value) %>% 
  mutate(gdp_growth = gdp_growth/100) %>% 
  mutate(year = as.numeric(year))

ke_gdp
```

# Business Registrations Forecast

**Assumption:** Business registrations is a factor of National GDP.

National GDP was chosen since it is the only one that has forecasted values.

## ARIMAX model

```{r}
gdp_reg <-
ke_business_reg %>%
  full_join(ke_gdp, by = "year") %>%
  arrange(year) %>% 
  filter(!is.na(gdp_growth), !is.na(business_reg))

gdp_reg
```

```{r}
reg_model <- auto.arima(y = gdp_reg$business_reg, xreg = gdp_reg$gdp_growth)

reg_model
```

## Forecasted values

Forecast business registrations from 2022 to 2030. It is estimated that GDP will grow at 4.4% between 2020-2030.

```{r}
forecast(object = reg_model, 
         h = 9, 
         xreg = rep(0.044, times = 9)) %>% 
  plot()


reg_forecast <-
forecast(object = reg_model, 
         h = 9, 
         xreg = rep(0.044, times = 9)) %>% 
  as_tibble() %>% 
  janitor::clean_names() %>% 
  rename(business_reg = point_forecast) %>% 
  mutate(year = 2022:2030) %>% 
  bind_rows(ke_business_reg) %>% 
  arrange(year) %>% 
  relocate(year, .before = everything()) %>% 
  mutate(business_reg = round(business_reg))

reg_forecast
```

## CAGR

```{r}
CAGR_formula <- function(FV, PV, yrs) {
cagr <- ((FV/PV)^(1/yrs)-1)
return(cagr)
}

reg_cagr <- CAGR_formula(FV = 66120, PV = 46387, yrs = 2030-2022)
reg_cagr <- scales::percent(reg_cagr, accuracy = 0.01)
reg_cagr
```

## Plotted results

```{r}
reg_forecast %>% 
  ggplot(aes(x = year, y = business_reg)) +
  geom_line() +
  geom_ribbon(aes(ymin = lo_95, ymax = hi_95, alpha = 0.3), 
              fill = "grey70", 
              show.legend = FALSE) +
  scale_y_continuous(labels = scales::comma_format()) +
  scale_x_continuous(breaks = seq(2000, 2030, 5), minor_breaks = NULL) +
  expand_limits(y = 0, x = 2000) +
  labs(title = "Growth of Business Registrations in Kenya [2002-2030]",
       subtitle = glue::glue("Projected to grow at a CAGR of {reg_cagr} from 2022-2030"),
       x = NULL,
       y = "Number of Business Registrations")
```

# Employment Ratio Forecast

## ARIMAX model

```{r}
reg_forecast
ke_gdp
ke_inflation_rates
ke_employment_ratios

emp_data <-
full_join(x = ke_gdp, y = reg_forecast, by = "year") %>% 
  full_join(ke_inflation_rates, by = "year") %>% 
  full_join(ke_employment_ratios, by = "year") %>% 
  arrange(year) %>% 
  select(-starts_with(c("lo", "hi"))) %>% 
  relocate(employment_ratio, .after = year) %>% 
  filter(complete.cases(.))

emp_data
```


```{r}
emp_data %>% 
  select(-year, employment_ratio) %>% 
  as.matrix()
```


```{r}
emp_model <-
auto.arima(y = emp_data$employment_ratio, 
           xreg = emp_data %>%
             select(-year, -employment_ratio) %>%
             as.matrix())

emp_model
```

## Forecasted values

Forecast unemployment rates from 2021-2030

```{r}
emp_newdata <-
full_join(x = ke_gdp, y = reg_forecast, by = "year") %>% 
  full_join(ke_inflation_rates, by = "year") %>% 
  full_join(ke_employment_ratios, by = "year") %>% 
  arrange(year) %>% 
  select(-starts_with(c("lo", "hi"))) %>% 
  relocate(employment_ratio, .after = year) %>% 
  filter(year>=2021) %>% 
  select(-year, -employment_ratio) %>% 
  as.matrix()

emp_newdata
```

```{r}
forecast(object = emp_model, h = 10, xreg = emp_newdata) %>% plot()

emp_forecast <-
forecast(object = emp_model, h = 10, xreg = emp_newdata) %>% 
  as_tibble() %>% 
  janitor::clean_names() %>% 
  mutate(year = 2021:2030) %>% 
  relocate(year, .before = everything()) %>% 
  rename(employment_ratio = point_forecast)

emp_forecast
```


```{r}
emp_complete <-
full_join(x = ke_gdp, y = reg_forecast, by = "year") %>% 
  full_join(ke_inflation_rates, by = "year") %>% 
  full_join(ke_employment_ratios, by = "year") %>% 
  arrange(year) %>% 
  select(-starts_with(c("lo", "hi"))) %>% 
  relocate(employment_ratio, .after = year) %>% 
  left_join(emp_forecast, by = "year") %>% 
  mutate(employment_ratio = coalesce(employment_ratio.x, employment_ratio.y)) %>% 
  select(-employment_ratio.x, -employment_ratio.y) %>% 
  select(-contains("80")) %>% 
  arrange(year) %>% 
  filter(year>=2002)

emp_complete
```

## Growth rate

```{r}
emp_ratios <-
emp_complete %>% 
  filter(year>=2020) %>% 
  pull(employment_ratio)

emp_ratios %>% 
  mean() %>% 
  scales::percent(accuracy = 0.01)

emp_2030 <- scales::percent(emp_ratios[length(emp_ratios)], accuracy = 0.01)
emp_2020 <- scales::percent(emp_ratios[1], accuracy = 0.01)
emp_2030
```

## Plotted results

```{r}
emp_complete %>% 
  ggplot(aes(x = year, y = employment_ratio)) +
  geom_line() +
  geom_ribbon(aes(ymin = lo_95, ymax = hi_95, alpha = 0.3), 
              fill = "grey70", 
              show.legend = FALSE) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_continuous(breaks = seq(2000, 2030, 5), minor_breaks = NULL) +
  geom_text(aes(label = scales::percent(employment_ratio, accuracy = 0.01)), 
            check_overlap = TRUE) +
  expand_limits(x = 2000) +
  labs(title = "Employment Ratios in Kenya [2002-2030]",
       subtitle = glue::glue("Employment is expected to reduce to {emp_2030} by 2030 from {emp_2020} in 2020"),
       x = NULL,
       y = "Employment Ratio")
```

# Save results

```{r}
write_xlsx(x = emp_complete, path = "./outputs/emp_complete.xlsx")
```


```{r}
save.image(file = "27_Oct.RData")
```






